<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zamów swoje kampanie QR</title>
    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #1f2937;
        background-color: #f5f7fb;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at 10% 10%, rgba(99, 102, 241, 0.12), transparent 60%),
          radial-gradient(circle at 80% 0%, rgba(56, 189, 248, 0.18), transparent 55%), #f5f7fb;
        color: inherit;
        display: flex;
        justify-content: center;
        padding: clamp(24px, 4vw, 64px) 16px 72px;
      }
      .container {
        width: min(1100px, 100%);
        background: #ffffff;
        border-radius: 28px;
        padding: clamp(24px, 5vw, 56px);
        box-shadow: 0 45px 90px rgba(15, 23, 42, 0.08);
        display: grid;
        gap: clamp(28px, 4vw, 48px);
      }
      header {
        display: grid;
        gap: 20px;
      }
      .logo-slot {
        width: 180px;
        height: 60px;
        border-radius: 16px;
        border: 2px dashed rgba(148, 163, 184, 0.6);
        display: grid;
        place-items: center;
        font-weight: 600;
        color: rgba(100, 116, 139, 0.9);
        background: rgba(248, 250, 252, 0.9);
      }
      header h1 {
        margin: 0;
        font-size: clamp(2.1rem, 4vw, 3rem);
        color: #0f172a;
      }
      header p {
        margin: 0;
        line-height: 1.7;
        font-size: 1.08rem;
        color: rgba(71, 85, 105, 0.95);
      }
      .features {
        display: grid;
        gap: 16px;
      }
      .feature {
        border-radius: 18px;
        background: linear-gradient(135deg, rgba(219, 234, 254, 0.5), rgba(244, 244, 255, 0.65));
        padding: 24px;
        border: 1px solid rgba(99, 102, 241, 0.12);
      }
      .feature h3 {
        margin: 0 0 8px;
        font-size: 1.2rem;
        color: #1d4ed8;
      }
      .feature p {
        margin: 0;
        color: rgba(71, 85, 105, 0.9);
        line-height: 1.6;
      }
      .price-box {
        background: linear-gradient(135deg, rgba(56, 189, 248, 0.18), rgba(129, 140, 248, 0.2));
        border-radius: 24px;
        padding: 28px;
        display: grid;
        gap: 12px;
        border: 1px solid rgba(129, 140, 248, 0.35);
      }
      .price-main {
        font-size: clamp(2.4rem, 5vw, 3rem);
        font-weight: 800;
        display: flex;
        flex-wrap: wrap;
        align-items: baseline;
        gap: 12px;
        color: #0f172a;
      }
      .price-note {
        font-size: 0.97rem;
        color: rgba(51, 65, 85, 0.8);
      }
      .validity-note {
        font-weight: 600;
        color: #1d4ed8;
      }
      .extension-calculator {
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(129, 140, 248, 0.35);
        padding: 20px;
        display: grid;
        gap: 12px;
      }
      .extension-calculator h3 {
        margin: 0;
        font-size: 1.1rem;
        color: #0f172a;
      }
      .extension-controls {
        display: inline-flex;
        align-items: center;
        gap: 12px;
      }
      .extension-controls button {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #c7d2fe, #bfdbfe);
        color: #1e3a8a;
        box-shadow: 0 10px 18px rgba(79, 70, 229, 0.15);
      }
      .extension-controls button:disabled {
        background: rgba(191, 219, 254, 0.6);
        color: rgba(30, 58, 138, 0.4);
        box-shadow: none;
      }
      .extension-summary {
        margin: 0;
        font-size: 0.95rem;
        color: rgba(51, 65, 85, 0.92);
        line-height: 1.6;
      }
      .promo-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
        align-items: center;
      }
      button {
        border: none;
        border-radius: 9999px;
        padding: 12px 24px;
        font: inherit;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
      }
      button.primary {
        background: linear-gradient(135deg, #60a5fa, #38bdf8);
        color: #0f172a;
        box-shadow: 0 20px 40px rgba(56, 189, 248, 0.35);
      }
      button.secondary {
        background: #ffffff;
        color: #2563eb;
        border: 1px solid rgba(37, 99, 235, 0.35);
      }
      button:disabled {
        opacity: 0.6;
        cursor: wait;
      }
      button:hover:not(:disabled) {
        transform: translateY(-1px);
      }
      .promo-feedback {
        flex: 1 1 240px;
        font-size: 0.95rem;
        line-height: 1.45;
      }
      .promo-feedback span {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border-radius: 9999px;
      }
      .promo-feedback .info {
        background: rgba(129, 140, 248, 0.15);
        color: #1d4ed8;
      }
      .promo-feedback .success {
        background: rgba(34, 197, 94, 0.18);
        color: #15803d;
      }
      .promo-feedback .error {
        background: rgba(248, 113, 113, 0.22);
        color: #b91c1c;
      }
      form {
        display: grid;
        gap: 24px;
      }
      .steps-indicator {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }
      .steps-indicator li {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(248, 250, 252, 0.9);
        color: rgba(71, 85, 105, 0.8);
        font-weight: 600;
      }
      .steps-indicator li.active {
        border-color: rgba(37, 99, 235, 0.6);
        background: rgba(219, 234, 254, 0.8);
        color: #1d4ed8;
      }
      .steps-indicator span {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: rgba(37, 99, 235, 0.12);
        color: #2563eb;
        font-weight: 700;
      }
      .step {
        display: none;
        gap: 20px;
        border-radius: 20px;
        padding: clamp(20px, 4vw, 32px);
        background: rgba(248, 250, 252, 0.8);
        border: 1px solid rgba(226, 232, 240, 0.9);
      }
      .step.active {
        display: grid;
      }
      .row {
        display: grid;
        gap: 18px;
      }
      @media (min-width: 760px) {
        .row.two {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      label {
        display: grid;
        gap: 8px;
        font-weight: 600;
        color: #1f2937;
      }
      input,
      select,
      textarea {
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        padding: 12px 14px;
        font: inherit;
        color: inherit;
        background: #ffffff;
      }
      textarea {
        resize: vertical;
        min-height: 120px;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: rgba(37, 99, 235, 0.75);
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
      }
      .note {
        font-size: 0.9rem;
        color: rgba(100, 116, 139, 0.9);
      }
      .checkbox {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px 18px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.4);
      }
      .checkbox input[type="checkbox"] {
        margin-top: 4px;
        width: 20px;
        height: 20px;
      }
      .hidden {
        display: none !important;
      }
      .actions {
        display: flex;
        justify-content: space-between;
        gap: 12px;
      }
      .actions .spacer {
        flex: 1;
      }
      .summary-card {
        background: #ffffff;
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 20px;
        display: grid;
        gap: 12px;
      }
      .summary-card dl {
        margin: 0;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px 24px;
      }
      .summary-card dt {
        font-weight: 600;
        color: #1f2937;
      }
      .summary-card dd {
        margin: 0;
        color: rgba(71, 85, 105, 0.9);
      }
      .payment-module {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(221, 242, 255, 0.9));
        border-radius: 20px;
        border: 1px solid rgba(56, 189, 248, 0.35);
        padding: 24px;
        display: grid;
        gap: 16px;
      }
      .payment-module h3 {
        margin: 0;
        font-size: 1.35rem;
        color: #0f172a;
      }
      .payment-module .payment-options {
        display: grid;
        gap: 12px;
      }
      .payment-option {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 12px;
        align-items: center;
        padding: 12px 16px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.35);
        cursor: pointer;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      .payment-option input[type="radio"] {
        width: 20px;
        height: 20px;
        accent-color: #2563eb;
      }
      .payment-option .option-content span {
        font-weight: 700;
        color: #0f172a;
      }
      .payment-option .option-content small {
        display: block;
        color: rgba(71, 85, 105, 0.85);
        margin-top: 4px;
      }
      .payment-option:hover {
        border-color: rgba(37, 99, 235, 0.6);
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.12);
      }
      .payment-option.active {
        border-color: rgba(37, 99, 235, 0.9);
        box-shadow: 0 14px 26px rgba(37, 99, 235, 0.18);
        background: linear-gradient(135deg, rgba(219, 234, 254, 0.75), rgba(191, 219, 254, 0.6));
      }
      .payment-module .blik-field {
        display: grid;
        gap: 8px;
        max-width: 260px;
      }
      .payment-module .blik-field.hidden {
        display: none;
      }
      .payment-module input[type="tel"] {
        letter-spacing: 6px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
      }
      .result {
        border-radius: 24px;
        border: 1px solid rgba(129, 140, 248, 0.35);
        background: rgba(237, 242, 255, 0.9);
        padding: 28px;
        display: grid;
        gap: 16px;
      }
      .result pre {
        margin: 0;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        padding: 18px;
        overflow: auto;
      }
      .error {
        color: #dc2626;
        font-weight: 600;
      }
      footer {
        display: grid;
        gap: 12px;
        padding-top: 28px;
        border-top: 1px solid rgba(148, 163, 184, 0.35);
        font-size: 0.9rem;
        color: rgba(71, 85, 105, 0.85);
      }
      footer .company-data {
        display: grid;
        gap: 6px;
      }
      footer strong {
        color: #0f172a;
      }
      .footer-links {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
      }
      .footer-links a {
        color: #2563eb;
        font-weight: 600;
        text-decoration: none;
      }
      .footer-links a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body
    data-endpoint="https://your-api-endpoint.example.com/order"
    data-fb-profile-url="https://www.facebook.com/sowa.rezerwacje/"
  >
    <div class="container">
      <header>
        <div class="logo-slot">Twoje logo</div>
        <div>
          <h1>Zamów kampanię kodów QR, która zwiększa sprzedaż</h1>
          <p>
            Idealne rozwiązanie dla małych firm, sklepów czy gastronomii, które chcą szybko uruchomić promocję bez skomplikowanych systemów lojalnościowych. W kilku krokach określisz zasady, a my przygotujemy kody gotowe do publikacji. Dzięki naszym kodom możesz na bieżąco weryfikować liczbę skanów i reagować na wyniki kampanii.
          </p>
        </div>
        <div class="features">
          <article class="feature">
            <h3>Kupony z licznikiem</h3>
            <p>
              Ustal ile razy oferta może zostać zeskanowana. System automatycznie zatrzyma kampanię, gdy limit zostanie wykorzystany.
            </p>
          </article>
          <article class="feature">
            <h3>Dwa kody QR</h3>
            <p>
              Otrzymasz kod do publikacji i kod testowy – dzięki temu możesz spokojnie sprawdzić działanie promocji przed startem.
            </p>
          </article>
          <article class="feature">
            <h3>Dowolna prezentacja</h3>
            <p>
              Zdecyduj, czy po skanowaniu klient zobaczy stronę www, kod rabatowy na ekranie, czy dedykowaną grafikę Twojej marki.
            </p>
          </article>
        </div>
      </header>

      <section class="price-box" id="priceBox">
        <div class="price-main">
          <span id="priceValue">9,99 zł</span>
          <span class="price-note" id="priceNote">za przygotowanie kampanii</span>
        </div>
        <p class="price-note">
          W cenie otrzymujesz konfigurację promocji, materiały z kodami QR w formacie PNG oraz krótką instrukcję publikacji.
        </p>
        <p class="price-note validity-note">
          Kody QR są ważne 49 dni od startu kampanii. Każde dodatkowe 15 dni kosztuje 0,75 zł.
        </p>
        <div class="extension-calculator" aria-live="polite">
          <h3>Przedłuż ważność kodów QR</h3>
          <p class="price-note">
            Każdy PLUS dodaje 15 dni ważności i kosztuje 0,75 zł. Dopasuj liczbę PLUS-ów do potrzeb swojej kampanii.
          </p>
          <div class="extension-controls">
            <button type="button" id="extensionMinus" aria-label="Usuń PLUS">−</button>
            <strong id="extensionCount">0</strong>
            <button type="button" id="extensionPlus" aria-label="Dodaj PLUS">+</button>
          </div>
          <p class="extension-summary" id="extensionSummary">
            Dodatkowy czas: <span id="extraDays">0</span> dni · Dopłata: <span id="extraCost">0,00 zł</span><br />
            Łączna ważność: <span id="totalValidity">49</span> dni · Łączna cena: <span id="totalPrice">9,99 zł</span>
          </p>
        </div>
        <div class="promo-actions">
          <button type="button" class="secondary" id="promoButton">
            Odwiedź nasz profil na Facebooku – cena niższa o 2 zł
          </button>
          <div class="promo-feedback" id="promoFeedback">
            <span class="info"
              >Kliknij przycisk, aby otworzyć profil w nowej karcie. Po powrocie na tę stronę naliczymy rabat.</span
            >
          </div>
        </div>
      </section>

      <form id="orderForm">
        <input type="hidden" name="extensionUnits" id="extensionUnits" value="0" />
        <ol class="steps-indicator">
          <li class="active"><span>1</span>Adres e-mail</li>
          <li><span>2</span>Parametry kampanii</li>
          <li><span>3</span>Faktura i notatki</li>
          <li><span>4</span>Podsumowanie i płatność</li>
        </ol>

        <section class="step active" data-step="1">
          <label>
            Adres e-mail do potwierdzenia
            <input type="email" name="email" required placeholder="np. sklep@example.com" />
          </label>
          <span class="note">Na ten adres wyślemy potwierdzenie zamówienia oraz materiały do kampanii.</span>
        </section>

        <section class="step" data-step="2">
          <div class="row two">
            <label>
              Liczba skanów w promocji
              <input type="number" name="maxScans" min="1" max="9999" required placeholder="np. 25" />
            </label>
            <label>
              Typ promocji
              <select name="promotionType" id="promotionType" required>
                <option value="redirect">Przekierowanie na stronę</option>
                <option value="promo_code">Wyświetlenie kodu rabatowego</option>
                <option value="image">Wyświetlenie grafiki z promocją</option>
              </select>
            </label>
          </div>
          <label>
            Data i godzina startu kampanii
            <input type="datetime-local" name="campaignStart" required />
          </label>
          <div id="redirectFields" class="row hidden">
            <label>
              Adres URL do przekierowania
              <input type="url" name="redirectUrl" placeholder="https://twoja-promocja.pl" />
            </label>
          </div>
          <div id="promoCodeFields" class="row hidden">
            <label>
              Kod rabatowy wyświetlany po zeskanowaniu
              <input type="text" name="promoCode" placeholder="np. RABAT-10" />
            </label>
          </div>
          <div id="imageFields" class="row hidden">
            <label>
              Link do grafiki promocyjnej
              <input type="url" name="imagePath" placeholder="https://cdn.twojemateriały.pl/kupon.jpg" />
            </label>
            <span class="note">Załaduj grafikę do własnej chmury i wklej bezpośredni adres URL.</span>
          </div>
          <label>
            Opcjonalny kod kasowy (dla obsługi)
            <input type="text" name="cashierCode" placeholder="np. POS-123" />
          </label>
        </section>

        <section class="step" data-step="3">
          <label>
            Dodatkowe uwagi (np. kolorystyka materiałów, format plików)
            <textarea name="notes" placeholder="Jakie detale mamy uwzględnić?"></textarea>
          </label>
          <div class="checkbox">
            <input type="checkbox" id="invoiceCheckbox" name="invoice" />
            <label for="invoiceCheckbox">Firma – potrzebuję faktury VAT 23%</label>
          </div>
          <label id="companyDetails" class="hidden">
            Dane do faktury (nazwa firmy, NIP, adres)
            <textarea name="invoiceDetails" placeholder="Wpisz wszystkie dane rozliczeniowe"></textarea>
          </label>
        </section>

        <section class="step" data-step="4">
          <div class="summary-card">
            <h3>Podsumowanie zamówienia</h3>
            <dl id="summaryList"></dl>
            <p class="note" id="summaryPriceNote"></p>
          </div>
          <div class="payment-module">
            <h3>Wybierz metodę płatności</h3>
            <div class="payment-options" id="paymentOptions">
              <label class="payment-option active">
                <input type="radio" name="paymentMethod" value="blik" checked />
                <div class="option-content">
                  <span>BLIK</span>
                  <small>Natychmiastowe potwierdzenie i szybkie wygenerowanie kampanii.</small>
                </div>
              </label>
              <label class="payment-option">
                <input type="radio" name="paymentMethod" value="transfer" />
                <div class="option-content">
                  <span>Szybki przelew</span>
                  <small>Przekierowanie do Przelewy24 i finalizacja w banku.</small>
                </div>
              </label>
            </div>
            <div class="blik-field" id="blikField">
              <label>
                Kod BLIK
                <input type="tel" id="blikCode" name="blikCode" inputmode="numeric" pattern="\d{6}" maxlength="6" placeholder="••••••" required />
              </label>
              <span class="note">Wpisz sześciocyfrowy kod z aplikacji bankowej.</span>
            </div>
            <p class="note" id="paymentNote">Płatność online – finalizacja zamówienia nastąpi po potwierdzeniu kodu BLIK.</p>
            <p class="error hidden" id="paymentError"></p>
          </div>
        </section>

        <div class="actions">
          <button type="button" class="secondary" id="prevButton">Wstecz</button>
          <span class="spacer"></span>
          <button type="button" class="primary" id="nextButton">Dalej</button>
          <button type="submit" class="primary hidden" id="submitButton">Opłać i zamów</button>
        </div>
      </form>

      <section id="result" class="result hidden"></section>

      <footer>
        <div class="company-data">
          <strong>Itc Wojciech Nawracała</strong>
          <span>UL. KAMIENNA 10928, 50-547 Wrocław, woj. dolnośląskie</span>
          <span>NIP: 9291772633 &bull; REGON: 02228614300000</span>
          <span>E-mail: <a href="mailto:konto@itcwn.pl">konto@itcwn.pl</a></span>
        </div>
        <div class="footer-links">
          <a href="polityka-prywatnosci.html">Polityka prywatności</a>
          <a href="regulamin.html">Regulamin serwisu</a>
          <a href="#orderForm">Formularz zamówienia</a>
        </div>
        <span>&copy; 2024 Itc Wojciech Nawracała. Wszystkie prawa zastrzeżone.</span>
      </footer>
    </div>

    <script>
      const form = document.getElementById("orderForm");
      const steps = Array.from(document.querySelectorAll(".step"));
      const stepIndicators = Array.from(document.querySelectorAll(".steps-indicator li"));
      const nextButton = document.getElementById("nextButton");
      const prevButton = document.getElementById("prevButton");
      const submitButton = document.getElementById("submitButton");
      const resultBox = document.getElementById("result");
      const promotionType = document.getElementById("promotionType");
      const redirectFields = document.getElementById("redirectFields");
      const promoCodeFields = document.getElementById("promoCodeFields");
      const imageFields = document.getElementById("imageFields");
      const invoiceCheckbox = document.getElementById("invoiceCheckbox");
      const companyDetails = document.getElementById("companyDetails");
      const summaryList = document.getElementById("summaryList");
      const summaryPriceNote = document.getElementById("summaryPriceNote");
      const blikCode = document.getElementById("blikCode");
      const blikField = document.getElementById("blikField");
      const paymentOptionInputs = Array.from(
        document.querySelectorAll('input[name="paymentMethod"]'),
      );
      const paymentNote = document.getElementById("paymentNote");
      const paymentError = document.getElementById("paymentError");
      const priceValue = document.getElementById("priceValue");
      const priceNote = document.getElementById("priceNote");
      const promoButton = document.getElementById("promoButton");
      const promoFeedback = document.getElementById("promoFeedback");
      const extensionMinus = document.getElementById("extensionMinus");
      const extensionPlus = document.getElementById("extensionPlus");
      const extensionCountDisplay = document.getElementById("extensionCount");
      const extensionUnitsInput = document.getElementById("extensionUnits");
      const extraDaysDisplay = document.getElementById("extraDays");
      const extraCostDisplay = document.getElementById("extraCost");
      const totalValidityDisplay = document.getElementById("totalValidity");
      const totalPriceDisplay = document.getElementById("totalPrice");
      const fbProfileUrl = document.body.dataset.fbProfileUrl;
      const hasFacebookConfig =
        Boolean(fbProfileUrl && fbProfileUrl !== "https://www.facebook.com/YOUR_FACEBOOK_PAGE");
      const defaultPromoMessage =
        "Kliknij przycisk, aby otworzyć profil w nowej karcie. Po powrocie naliczymy rabat 2 zł.";
      const promoButtonDefaultText = promoButton.textContent.trim();

      const API_ENDPOINT = document.body.dataset.endpoint;
      let currentStep = 0;
      const BASE_VALIDITY_DAYS = 49;
      const EXTENSION_DAYS = 15;
      const EXTENSION_COST = 0.75;
      const STANDARD_PRICE = 9.99;
      const PROMO_DISCOUNT = 2.0;
      const PROMO_PRICE = Number((STANDARD_PRICE - PROMO_DISCOUNT).toFixed(2));
      let currentPrice = STANDARD_PRICE;
      let promoActive = false;
      let promoPending = false;
      let extensionUnits = 0;

      function formatPrice(value) {
        return value.toFixed(2).replace(".", ",") + " zł";
      }

      function formatDateTime(value) {
        if (!value) {
          return "—";
        }
        const [datePart, timePart] = value.split("T");
        if (!timePart) {
          return value;
        }
        return `${datePart} ${timePart}`;
      }

      function getSelectedPaymentMethod() {
        const selected = paymentOptionInputs.find((input) => input.checked);
        return selected ? selected.value : "blik";
      }

      function updatePaymentSelectionUI() {
        const method = getSelectedPaymentMethod();
        paymentOptionInputs.forEach((input) => {
          const option = input.closest(".payment-option");
          if (option) {
            option.classList.toggle("active", input.checked);
          }
        });

        if (method === "blik") {
          blikField.classList.remove("hidden");
          blikCode.required = true;
          paymentNote.textContent =
            "Płatność online – finalizacja zamówienia nastąpi po potwierdzeniu kodu BLIK.";
        } else {
          blikField.classList.add("hidden");
          blikCode.required = false;
          blikCode.value = "";
          paymentNote.textContent =
            "Po wysłaniu formularza przekierujemy Cię do szybkiego przelewu Przelewy24.";
        }
      }

      function calculateTotalPrice() {
        return (promoActive ? PROMO_PRICE : STANDARD_PRICE) + extensionUnits * EXTENSION_COST;
      }

      function calculateTotalValidity() {
        return BASE_VALIDITY_DAYS + extensionUnits * EXTENSION_DAYS;
      }

      function updatePricingDisplays() {
        const totalPriceNumber = Number(calculateTotalPrice().toFixed(2));
        currentPrice = totalPriceNumber;
        priceValue.textContent = formatPrice(totalPriceNumber);
        totalPriceDisplay.textContent = formatPrice(totalPriceNumber);
        priceNote.textContent = promoActive
          ? "po odwiedzeniu naszego profilu na Facebooku"
          : "za przygotowanie kampanii";
      }

      function updateExtensionDisplays() {
        extensionCountDisplay.textContent = String(extensionUnits);
        const extraDays = extensionUnits * EXTENSION_DAYS;
        const extraCostNumber = Number((extensionUnits * EXTENSION_COST).toFixed(2));
        extraDaysDisplay.textContent = String(extraDays);
        extraCostDisplay.textContent = formatPrice(extraCostNumber);
        totalValidityDisplay.textContent = String(calculateTotalValidity());
        extensionUnitsInput.value = String(extensionUnits);
        extensionMinus.disabled = extensionUnits === 0;
        updatePricingDisplays();
      }

      function setPromoFeedback(message, variant = "info") {
        if (!promoFeedback) return;
        promoFeedback.innerHTML = `<span class="${variant}">${message}</span>`;
      }

      function activatePromo() {
        promoActive = true;
        promoPending = false;
        updatePricingDisplays();
        promoButton.disabled = true;
        promoButton.textContent = "Rabat Facebook aktywny";
        if (currentStep === steps.length - 1) {
          populateSummary();
        }
      }

      function handlePromoClick() {
        if (promoActive || promoPending) {
          return;
        }
        if (!hasFacebookConfig) {
          setPromoFeedback(
            "Skonfiguruj adres profilu Facebook w atrybucie data-fb-profile-url na elemencie <body>.",
            "error"
          );
          return;
        }
        const newTab = window.open(fbProfileUrl, "_blank", "noopener");
        if (!newTab) {
          setPromoFeedback(
            "Pozwól na otwieranie nowych kart w przeglądarce, aby dokończyć aktywację rabatu.",
            "error"
          );
          return;
        }
        promoPending = true;
        promoButton.disabled = true;
        promoButton.textContent = "Odwiedź profil i wróć, aby aktywować rabat";
        setPromoFeedback("Po powrocie na tę kartę naliczymy rabat 2 zł.", "info");
        newTab.focus();
      }

      function handleWindowFocus() {
        if (!promoPending || promoActive) {
          return;
        }
        activatePromo();
        setPromoFeedback("Dziękujemy za odwiedzenie profilu! Rabat 2 zł został naliczony.", "success");
      }

      function toggleFields(type) {
        redirectFields.classList.toggle("hidden", type !== "redirect");
        promoCodeFields.classList.toggle("hidden", type !== "promo_code");
        imageFields.classList.toggle("hidden", type !== "image");
        redirectFields.querySelector("input").required = type === "redirect";
        promoCodeFields.querySelector("input").required = type === "promo_code";
        imageFields.querySelector("input").required = type === "image";
      }

      function updateSteps() {
        steps.forEach((step, index) => {
          step.classList.toggle("active", index === currentStep);
        });
        stepIndicators.forEach((indicator, index) => {
          indicator.classList.toggle("active", index === currentStep);
        });
        prevButton.disabled = currentStep === 0;
        nextButton.classList.toggle("hidden", currentStep === steps.length - 1);
        submitButton.classList.toggle("hidden", currentStep !== steps.length - 1);
        if (currentStep === steps.length - 1) {
          populateSummary();
        }
      }

      function validateStep(stepIndex) {
        const step = steps[stepIndex];
        const inputs = Array.from(step.querySelectorAll("input, select, textarea"));
        return inputs.every((input) => input.checkValidity());
      }

      function populateSummary() {
        const formData = new FormData(form);
        const extensionUnitsValue = Number(formData.get("extensionUnits") || "0");
        const extensionCostValue = Number((extensionUnitsValue * EXTENSION_COST).toFixed(2));
        const totalValidity = BASE_VALIDITY_DAYS + extensionUnitsValue * EXTENSION_DAYS;
        const startDate = formData.get("campaignStart");
        const map = [
          { label: "E-mail", value: formData.get("email") },
          { label: "Start kampanii", value: formatDateTime(startDate) },
          { label: "Limit skanów", value: formData.get("maxScans") },
          {
            label: "Typ prezentacji",
            value:
              {
                redirect: "Przekierowanie na stronę",
                promo_code: "Kod rabatowy",
                image: "Grafika promocyjna",
              }[formData.get("promotionType")] || "—",
          },
          { label: "Adres URL", value: formData.get("redirectUrl") || "—" },
          { label: "Kod rabatowy", value: formData.get("promoCode") || "—" },
          { label: "Grafika", value: formData.get("imagePath") || "—" },
          { label: "Kod kasowy", value: formData.get("cashierCode") || "—" },
          { label: "Uwagi", value: formData.get("notes") || "Brak" },
          {
            label: "Faktura",
            value: formData.get("invoice") === "on" ? "Tak" : "Nie",
          },
          {
            label: "Dane do faktury",
            value:
              formData.get("invoice") === "on"
                ? formData.get("invoiceDetails") || "Zostaną uzupełnione później"
                : "—",
          },
          {
            label: "Dodatkowe PLUS-y",
            value:
              extensionUnitsValue > 0
                ? `${extensionUnitsValue} ( +${extensionUnitsValue * EXTENSION_DAYS} dni, dopłata ${formatPrice(extensionCostValue)})`
                : "0",
          },
          { label: "Łączna ważność kodów", value: `${totalValidity} dni` },
          {
            label: "Metoda płatności",
            value:
              getSelectedPaymentMethod() === "blik"
                ? "BLIK (natychmiastowa)"
                : "Szybki przelew (Przelewy24)",
          },
        ];

        summaryList.innerHTML = map
          .map((item) => `\n              <dt>${item.label}</dt>\n              <dd>${item.value || "—"}</dd>\n            `)
          .join("");

        const basePriceLabel = promoActive
          ? `Cena bazowa po odwiedzeniu profilu Facebook: ${formatPrice(PROMO_PRICE)}`
          : `Cena bazowa: ${formatPrice(STANDARD_PRICE)}`;
        const extensionLabel =
          extensionUnitsValue > 0 ? `, dopłata za PLUS-y: ${formatPrice(extensionCostValue)}` : "";
        summaryPriceNote.textContent = `Łączna cena do zapłaty: ${formatPrice(currentPrice)} (${basePriceLabel}${extensionLabel})`;
      }

      function goToStep(index) {
        if (index < 0 || index >= steps.length) return;
        currentStep = index;
        updateSteps();
      }

      promotionType.addEventListener("change", (event) => {
        toggleFields(event.target.value);
      });

      invoiceCheckbox.addEventListener("change", (event) => {
        companyDetails.classList.toggle("hidden", !event.target.checked);
        if (!event.target.checked) {
          companyDetails.querySelector("textarea").value = "";
        }
      });

      paymentOptionInputs.forEach((input) => {
        input.addEventListener("change", updatePaymentSelectionUI);
      });

      promoButton.addEventListener("click", handlePromoClick);
      window.addEventListener("focus", handleWindowFocus);

      nextButton.addEventListener("click", () => {
        if (!validateStep(currentStep)) {
          const step = steps[currentStep];
          const firstInvalid = step.querySelector(":invalid");
          if (firstInvalid) {
            firstInvalid.reportValidity();
          }
          return;
        }
        goToStep(currentStep + 1);
      });

      prevButton.addEventListener("click", () => {
        goToStep(currentStep - 1);
      });

      function ensureEndpointConfigured() {
        if (!API_ENDPOINT || API_ENDPOINT.includes("your-api-endpoint")) {
          throw new Error(
            "Skonfiguruj adres API w atrybucie data-endpoint na elemencie <body>."
          );
        }
      }

      function validateBlik() {
        if (getSelectedPaymentMethod() !== "blik") {
          return true;
        }
        return /^\d{6}$/.test(blikCode.value.trim());
      }

      async function submitOrder(event) {
        event.preventDefault();
        if (!validateStep(currentStep)) {
          return;
        }
        paymentError.classList.add("hidden");
        paymentError.textContent = "";
        const paymentMethod = getSelectedPaymentMethod();
        if (paymentMethod === "blik" && !validateBlik()) {
          paymentError.textContent = "Wpisz poprawny sześciocyfrowy kod BLIK.";
          paymentError.classList.remove("hidden");
          blikCode.focus();
          return;
        }

        try {
          ensureEndpointConfigured();
        } catch (configurationError) {
          paymentError.textContent = configurationError.message;
          paymentError.classList.remove("hidden");
          return;
        }

        submitButton.disabled = true;
        submitButton.textContent = "Przetwarzanie płatności...";
        resultBox.classList.add("hidden");
        resultBox.innerHTML = "";

        const formData = new FormData(form);
        const extensionUnitsValue = Number(formData.get("extensionUnits") || "0");
        const payload = {
          email: formData.get("email"),
          campaignStart: formData.get("campaignStart") || undefined,
          maxScans: Number(formData.get("maxScans")),
          promotionType: formData.get("promotionType"),
          promoCode: formData.get("promoCode") || undefined,
          redirectUrl: formData.get("redirectUrl") || undefined,
          imagePath: formData.get("imagePath") || undefined,
          cashierCode: formData.get("cashierCode") || undefined,
          invoiceRequested: formData.get("invoice") === "on",
          invoiceDetails: formData.get("invoiceDetails") || undefined,
          notes: formData.get("notes") || undefined,
          price: Number(currentPrice.toFixed(2)),
          extension: {
            units: extensionUnitsValue,
            extraDays: extensionUnitsValue * EXTENSION_DAYS,
            extraCost: Number((extensionUnitsValue * EXTENSION_COST).toFixed(2)),
            totalValidityDays: BASE_VALIDITY_DAYS + extensionUnitsValue * EXTENSION_DAYS,
          },
          payment:
            paymentMethod === "blik"
              ? {
                  method: "blik",
                  code: blikCode.value.trim(),
                }
              : {
                  method: "transfer",
                },
        };

        try {
          const response = await fetch(API_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const text = await response.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch (_) {
            throw new Error("Nie udało się odczytać odpowiedzi z serwera. Treść: " + text);
          }

          if (!response.ok) {
            throw new Error(data.error || data.message || "Wystąpił błąd podczas realizacji zamówienia.");
          }

          if (
            data.payment &&
            data.payment.method === "transfer" &&
            data.payment.redirectUrl
          ) {
            resultBox.classList.remove("hidden");
            resultBox.innerHTML = `
              <h2>Przekierowanie do płatności</h2>
              <p>Za chwilę przełączymy Cię na stronę Przelewy24, aby dokończyć płatność szybkim przelewem.</p>
              <p>Jeżeli przekierowanie nie nastąpi automatycznie, skorzystaj z linku: <a href="${data.payment.redirectUrl}" target="_blank" rel="noopener">otwórz płatność</a>.</p>
              <pre>${JSON.stringify(data.order || data, null, 2)}</pre>
            `;
            window.location.href = data.payment.redirectUrl;
            return;
          }

          resultBox.classList.remove("hidden");
          resultBox.innerHTML = `
            <h2>Zamówienie przyjęte</h2>
            <p>Twoja kampania została zapisana. W ciągu kilku minut otrzymasz e-mail z dwoma kodami QR oraz instrukcją wdrożenia.</p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
        } catch (error) {
          paymentError.textContent = error.message;
          paymentError.classList.remove("hidden");
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = "Opłać i zamów";
        }
      }

      form.addEventListener("submit", submitOrder);

      extensionPlus.addEventListener("click", () => {
        extensionUnits += 1;
        updateExtensionDisplays();
        if (currentStep === steps.length - 1) {
          populateSummary();
        }
      });

      extensionMinus.addEventListener("click", () => {
        if (extensionUnits === 0) {
          return;
        }
        extensionUnits -= 1;
        updateExtensionDisplays();
        if (currentStep === steps.length - 1) {
          populateSummary();
        }
      });

      updatePaymentSelectionUI();
      toggleFields(promotionType.value);
      updateSteps();
      if (hasFacebookConfig) {
        setPromoFeedback(defaultPromoMessage, "info");
        promoButton.textContent = promoButtonDefaultText;
      } else {
        promoButton.disabled = true;
        setPromoFeedback(
          "Skonfiguruj adres profilu Facebook w atrybucie data-fb-profile-url na elemencie <body>.",
          "error"
        );
      }
      updateExtensionDisplays();
    </script>
  </body>
</html>
